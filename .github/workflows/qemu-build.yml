name: Build qemu-system-arm

on:
  push:
    branches: [ "master", "ci-test" ]

jobs:
  qemu-build:
      runs-on: ubuntu-latest
      steps:
      - name: 'Fetch tags'
        id: qemu
        uses: hakwerk/gha-git-repo-tags@main
        with:
          repository: qemu/qemu
          limit: 1

      - name: 'Parse tags'
        run: echo "latest-tag=$(echo ${{ steps.qemu.outputs.tags }} | sed -e 's/^.//' -e 's/.$//')" >> $GITHUB_ENV

      - name: 'Check build condition'
        uses: mukunku/tag-exists-action@v1.6.0
        id: check-tag
        with: 
          tag: ${{ env.latest-tag }}
          repo: ${{ env.GITHUB_REPOSITORY }}

      - name: 'Update build condition'
        run: echo "skip-build=$(echo ${{steps.check-tag.outputs.exists}})" >> $GITHUB_ENV

      - name: 'Configure build dep'
        if: ${{ contains(env.skip-build, 'false')}}
        run: | 
          apt update && \
          apt install git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev ninja-build libslirp-dev

      - name: 'Checkout qemu/qemu @ ${{ env.latest-tag }}'
        if: ${{ contains(env.skip-build, 'false')}}
        uses: actions/checkout@v4
        with:
          repository: 'qemu/qemu'
          submodules: 'true'
          ref: ${{ env.latest-tag }}
    
      - name: 'Build'
        run: | 
          mkdir $GITHUB_WORKSPACE/output && \
          ./configure \
          --target-list=arm-softmmu \
          --enable-slirp \
          --disable-spice \
          --disable-docs \
          --disable-gtk \
          --disable-smartcard \
          --disable-usb-redir \
          --disable-libusb \
          --disable-sdl \
          --disable-gnutls \
          --disable-vte \
          --disable-vnc \
          --disable-werror \
          --prefix=$GITHUB_WORKSPACE/output && \
          make -j$(nproc) && \
          make install

      - name: 'Make release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{needs.check-build-condition.outputs.tag}}
          fail_on_unmatched_files: 'true'
          files: |
           output/bin/qemu-system-arm
        
  # query-latest-tag:
  #     runs-on: ubuntu-latest
  #     outputs:
  #       tag: ${{steps.qemu.outputs.tags}}
  #     steps:
  #     - id: qemu
  #       uses: hakwerk/gha-git-repo-tags@main
  #       with:
  #         repository: qemu/qemu
  #         limit: 1

  # check-build-condition:
  #   runs-on: ubuntu-latest
  #   needs: query-latest-tag
  #   outputs:
  #       skip: ${{steps.check-tag.outputs.exists}}
  #       tag: ${{ matrix.tag }}
  #   strategy:
  #     matrix:
  #       tag: ${{ fromJson( needs.query-latest-tag.outputs.tag ) }}
  #   steps:
  #     - uses: mukunku/tag-exists-action@v1.6.0
  #       id: check-tag
  #       with: 
  #         tag: ${{ matrix.tag }}
  #         repo: ${{ env.GITHUB_REPOSITORY }}
          
  # build:
  #   if: ${{ contains(needs.check-build-condition.outputs.skip, 'false')}}
  #   permissions:
  #     contents: write
  #   runs-on: ubuntu-latest
  #   needs: check-build-condition
  #   steps:
  #     - run: apt update && apt install git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev ninja-build libslirp-dev

  #     - uses: actions/checkout@v4
  #       with:
  #         repository: 'qemu/qemu'
  #         submodules: 'true'
  #         ref: ${{needs.check-build-condition.outputs.tag}}
          
  #     - run: | 
  #         mkdir $GITHUB_WORKSPACE/output && \
  #         ./configure \
  #         --target-list=arm-softmmu \
  #         --enable-slirp \
  #         --disable-spice \
  #         --disable-docs \
  #         --disable-gtk \
  #         --disable-smartcard \
  #         --disable-usb-redir \
  #         --disable-libusb \
  #         --disable-sdl \
  #         --disable-gnutls \
  #         --disable-vte \
  #         --disable-vnc \
  #         --disable-werror \
  #         --prefix=$GITHUB_WORKSPACE/output && \
  #         make -j$(nproc) && \
  #         make install
  
  #     - uses: softprops/action-gh-release@v2
  #       with:
  #         tag_name: ${{needs.check-build-condition.outputs.tag}}
  #         fail_on_unmatched_files: 'true'
  #         files: |
  #          output/bin/qemu-system-arm
