name: Build qemu-system-arm

on:
  push:
    branches: [ "master", "ci-test" ]

jobs:
  query-latest-tag:
      runs-on: ubuntu-latest
      outputs:
        tag: ${{steps.qemu.outputs.tags}}
      steps:
      - id: qemu
        uses: hakwerk/gha-git-repo-tags@main
        with:
          repository: qemu/qemu
          limit: 1

  check-build-condition:
    runs-on: ubuntu-latest
    needs: query-latest-tag
    outputs:
        skip: ${{steps.check-tag.outputs.exists}}
    strategy:
      matrix:
        tag: ${{ fromJson( needs.query-latest-tag.outputs.tag ) }}
    steps:
      - uses: mukunku/tag-exists-action@v1.6.0
        id: check-tag
        with: 
          tag: ${{ matrix.tag }}
          repo: ${{ env.GITHUB_REPOSITORY }}
          
  build:
    if: ${{needs.check-build-condition.outputs.skip}} == 'false'
    runs-on: ubuntu-latest
    needs: check-build-condition
    steps:
      - run: echo ${{needs.check-build-condition.strategy.matrix.tag}}
      # - uses: awalsh128/cache-apt-pkgs-action@latest
      #   with:
      #     packages: git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev ninja-build libslirp-dev

      # - uses: actions/checkout@v4
      #   with:
      #     repository: 'qemu/qemu'
      #     submodules: 'true'
          
      # - run: | 
      #     mkdir $GITHUB_WORKSPACE/output && \
      #     ./configure \
      #     --target-list=aarch64-softmmu \
      #     --enable-slirp \
      #     --disable-spice \
      #     --disable-docs \
      #     --disable-gtk \
      #     --disable-smartcard \
      #     --disable-usb-redir \
      #     --disable-libusb \
      #     --disable-sdl \
      #     --disable-gnutls \
      #     --disable-vte \
      #     --disable-vnc \
      #     --disable-werror \
      #     --prefix=$GITHUB_WORKSPACE/output && \
      #     make -j$(nproc) && \
      #     make install

      # - uses: softprops/action-gh-release@v2
      #   with:
      #     tag_name: ${{ needs.check-build-condition.strategy.matrix.tag }}
      #     files: |
      #       $GITHUB_WORKSPACE/output/bin/qemu-system-arm
